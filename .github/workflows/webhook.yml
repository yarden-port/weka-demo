- name: Sync using cached diff
  env:
    PORT_WEBHOOK_URL: https://ingest.getport.io/N29knvwPStVAcYnu
  run: |
    set -e
    trap '' SIGPIPE

    # Init counters
    echo 0 > created.count
    echo 0 > updated.count
    echo 0 > deleted.count

    new_map=$(cat new_map.json)
    old_map=$(cat old_map.json)

    # Create/Update loop
    while read -r entry; do
      id=$(echo "$entry" | jq -r '.key')
      new_block=$(echo "$entry" | jq -c '.value')
      old_block=$(echo "$old_map" | jq -c --arg id "$id" '.[$id] // empty')

      if [ -z "$old_block" ] || [ "$old_block" = "null" ]; then
        echo "🆕 $id - creating"
        count=$(cat created.count); echo $((count + 1)) > created.count
        op="create/update"
      else
        new_hash=$(echo "$new_block" | jq -S . | sha256sum | cut -d " " -f1)
        old_hash=$(echo "$old_block" | jq -S . | sha256sum | cut -d " " -f1)
        if [ "$new_hash" != "$old_hash" ]; then
          echo "🔁 $id - updating"
          count=$(cat updated.count); echo $((count + 1)) > updated.count
          op="create/update"
        else
          continue
        fi
      fi

      echo "$new_block" | jq --arg op "$op" '. + {operation: $op}' | \
        curl -s -X POST "$PORT_WEBHOOK_URL" \
          -H "Content-Type: application/json" \
          -d @-
    done < <(echo "$new_map" | jq -c 'to_entries[]')

    # Deletion loop
    while read -r old_id; do
      if ! echo "$new_map" | jq -e --arg id "$old_id" 'has($id)' > /dev/null; then
        echo "❌ $old_id - sending delete"
        count=$(cat deleted.count); echo $((count + 1)) > deleted.count
        jq -n --arg id "$old_id" --arg op "delete" '{
          system_id: $id,
          operation: $op
        }' | curl -s -X POST "$PORT_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d @-
      fi
    done < <(echo "$old_map" | jq -r 'keys[]')

    echo "✅ Sync complete"
    echo "Created: $(cat created.count)"
    echo "Updated: $(cat updated.count)"
    echo "Deleted: $(cat deleted.count)"
