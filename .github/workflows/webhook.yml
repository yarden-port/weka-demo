name: One-Time Full Sync to Port

on:
  workflow_dispatch:

jobs:
  one-time-sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up jq
        run: sudo apt-get install -y jq

      - name: Get Port Access Token
        id: get-token
        run: |
          token=$(curl -s -X POST 'https://api.getport.io/v1/auth/access_token' \
            -H 'Content-Type: application/json' \
            -d '{
              "clientId": "${{ secrets.PORT_CLIENT_ID }}",
              "clientSecret": "${{ secrets.PORT_CLIENT_SECRET }}"
            }' | jq -r '.accessToken')
          echo "PORT_ACCESS_TOKEN=$token" >> $GITHUB_ENV

      - name: Push all entities to Port (force create/update)
        env:
          PORT_WEBHOOK_URL: https://ingest.getport.io/N29knvwPStVAcYnu
        run: |
          set -e
          trap '' SIGPIPE

          jq -c '.[]' response_1743508042248.json | while read -r block; do
            echo "ðŸš€ Syncing entity..."
            echo "$block" | jq --arg op "create/update" '. + {operation: $op}' | tee payload.json | \
              curl -s -w "\nHTTP %{http_code}\n" -X POST "$PORT_WEBHOOK_URL" \
                -H "Content-Type: application/json" \
                -d @-
          done
